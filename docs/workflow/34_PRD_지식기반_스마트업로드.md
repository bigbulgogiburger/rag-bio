# PRD: 지식 기반 스마트 업로드

> **Version**: 1.0
> **작성일**: 2026-02-15
> **상태**: Draft
> **우선순위**: High
> **예상 스프린트**: Sprint 10-11 (2 sprints)

---

## 1. 배경 및 문제 정의

### 1.1 현재 상태 (As-Is)

현재 지식 기반 문서 업로드는 다음과 같은 제약을 가진다:

| 항목 | 현재 상태 | 문제점 |
|------|-----------|--------|
| 업로드 방식 | 기본 `<input type="file">` | 드래그&드롭 미지원, UX 불편 |
| 파일 수 | **1개씩** 단건 업로드 | 대량 문서 등록 시 반복 작업 필요 |
| 메타데이터 입력 | **수동 입력** (제목, 카테고리, 제품군, 설명, 태그) | 사용자 부담 높음, 입력 누락 빈번 |
| 문서 분석 | 업로드 후 인덱싱 단계에서만 텍스트 추출 | 업로드 시점에 문서 내용 파악 불가 |

### 1.2 핵심 페인포인트

1. **반복 업무**: CS 담당자가 매뉴얼/프로토콜 등 10-20건의 문서를 등록할 때 건건이 파일 선택 → 메타데이터 입력 → 등록을 반복해야 함
2. **메타데이터 품질**: 수동 입력으로 인한 카테고리 오분류, 불완전한 설명, 태그 누락이 검색 품질을 저하시킴
3. **UX 마찰**: 파일 탐색기를 열고 파일을 찾는 과정이 번거로움 (드래그&드롭이 업계 표준)

### 1.3 목표 (To-Be)

> 문서를 드래그&드롭으로 여러 건 한꺼번에 업로드하면,
> AI가 각 문서를 분석하여 메타데이터를 자동 생성하고,
> 사용자는 검토/수정 후 확인만 누르면 등록이 완료된다.

---

## 2. 사용자 스토리

### US-1: 드래그&드롭 파일 업로드
> **As a** CS 담당자,
> **I want to** 문서 파일을 업로드 영역에 드래그&드롭으로 올리고 싶다,
> **So that** 파일 탐색기를 열지 않고도 빠르게 업로드할 수 있다.

**인수 조건 (AC)**:
- [ ] 업로드 영역에 파일을 드래그하면 시각적 피드백(하이라이트)이 표시된다
- [ ] 드롭 시 파일이 큐에 추가된다
- [ ] 기존 "파일 선택" 버튼 클릭도 병행 지원한다
- [ ] 지원 포맷: PDF, DOC, DOCX (기존과 동일)
- [ ] 지원하지 않는 포맷의 파일 드롭 시 에러 메시지를 표시한다
- [ ] 개별 파일 최대 크기: 50MB, 초과 시 에러 메시지

### US-2: 다중 파일 업로드
> **As a** CS 담당자,
> **I want to** 여러 개의 문서를 한 번에 선택/드롭하여 일괄 등록하고 싶다,
> **So that** 대량 문서 등록 시 반복 작업을 줄일 수 있다.

**인수 조건 (AC)**:
- [ ] 한 번에 최대 **10개** 파일을 선택/드롭할 수 있다
- [ ] 업로드 큐에 추가된 파일 목록이 표시된다 (파일명, 크기, 상태)
- [ ] 개별 파일을 큐에서 제거할 수 있다 (X 버튼)
- [ ] 각 파일의 업로드 진행률이 표시된다 (프로그레스 바)
- [ ] 전체 진행 상황 요약이 표시된다 ("3/10건 완료")
- [ ] 일부 파일 실패 시 성공 건만 등록되고, 실패 건은 재시도 가능하다

### US-3: AI 메타데이터 자동 생성
> **As a** CS 담당자,
> **I want to** 업로드한 문서를 AI가 분석하여 제목/카테고리/제품군/설명/태그를 자동으로 채워주길 원한다,
> **So that** 메타데이터 입력 부담을 줄이고, 일관된 품질의 메타데이터를 확보할 수 있다.

**인수 조건 (AC)**:
- [ ] 파일 업로드 후 "AI 분석 중..." 로딩 상태가 표시된다
- [ ] AI가 추천한 메타데이터가 각 입력 필드에 자동으로 채워진다
- [ ] 자동 채워진 필드는 시각적으로 구분된다 (AI 추천 라벨/배지)
- [ ] 사용자가 AI 추천 값을 자유롭게 수정할 수 있다
- [ ] AI 분석 실패 시 수동 입력으로 폴백하며, 에러 메시지를 표시한다
- [ ] AI 분석 신뢰도 점수가 표시된다 (선택적)

---

## 3. 기능 상세 명세

### 3.1 드래그&드롭 업로드 컴포넌트

#### 3.1.1 UI 상태 머신

```
[IDLE] → (drag enter) → [DRAG_OVER] → (drop) → [FILES_QUEUED]
  ↑                         ↓
  ├── (drag leave) ─────────┘
  └── (click) → [FILE_DIALOG] → (select) → [FILES_QUEUED]

[FILES_QUEUED] → (upload start) → [UPLOADING] → [COMPLETED / PARTIAL_FAILURE]
```

#### 3.1.2 시각적 상태

| 상태 | 시각적 표현 |
|------|------------|
| IDLE | 점선 테두리 + 아이콘 + "파일을 드래그하거나 클릭하세요" |
| DRAG_OVER | 파란색 테두리 + 배경 하이라이트 + "파일을 놓으세요" |
| FILES_QUEUED | 파일 목록 카드 + 개별 삭제 버튼 |
| UPLOADING | 파일별 프로그레스 바 + 전체 진행률 |
| COMPLETED | 성공/실패 요약 + 재시도 옵션 |

#### 3.1.3 파일 검증 규칙

```typescript
const ALLOWED_TYPES = [
  'application/pdf',
  'application/msword',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
];
const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
const MAX_FILES = 10;
```

### 3.2 AI 메타데이터 분석

#### 3.2.1 분석 파이프라인

```
[파일 업로드] → [텍스트 추출 (첫 N페이지)] → [OpenAI API 호출] → [메타데이터 JSON 반환]
```

#### 3.2.2 새 API 엔드포인트

```
POST /api/v1/knowledge-base/documents/analyze-metadata
```

**Request**: `multipart/form-data`

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `file` | MultipartFile | Y | 분석할 문서 파일 |

**Response** (200 OK):

```json
{
  "suggestedTitle": "CFX96 Touch Real-Time PCR Detection System 사용자 매뉴얼",
  "suggestedCategory": "MANUAL",
  "suggestedProductFamily": "Real-Time PCR",
  "suggestedDescription": "Bio-Rad CFX96 Touch 시스템의 설치, 운영, 유지보수 가이드. 프로토콜 설정, 데이터 분석, 문제 해결 섹션을 포함합니다.",
  "suggestedTags": "CFX96, Real-Time PCR, 설치, 프로토콜, 문제해결",
  "confidence": 0.87,
  "extractedPageCount": 5,
  "analyzedTextLength": 8420
}
```

#### 3.2.3 AI 프롬프트 설계

```
시스템:
당신은 Bio-Rad 기술 문서 분류 전문가입니다.
업로드된 문서의 텍스트를 분석하여 다음 메타데이터를 추출하세요.

카테고리 분류 기준:
- MANUAL: 제품 사용자 매뉴얼, 설치 가이드
- PROTOCOL: 실험 프로토콜, SOP
- FAQ: 자주 묻는 질문, Q&A 문서
- SPEC_SHEET: 제품 사양서, 데이터시트
- TROUBLESHOOTING: 문제 해결 가이드
- OTHER: 위에 해당하지 않는 문서

출력 포맷: JSON
{
  "suggestedTitle": "문서의 핵심 제목 (한국어 또는 원문 유지)",
  "suggestedCategory": "MANUAL|PROTOCOL|FAQ|SPEC_SHEET|TROUBLESHOOTING|OTHER",
  "suggestedProductFamily": "관련 제품군 (예: Real-Time PCR, Electrophoresis)",
  "suggestedDescription": "2-3문장 요약",
  "suggestedTags": "쉼표로 구분된 키워드 5-8개",
  "confidence": 0.0 ~ 1.0
}
```

#### 3.2.4 텍스트 추출 전략

- PDF: 첫 **5페이지**만 추출 (전체 분석 불필요, 비용/시간 절약)
- DOC/DOCX: 첫 **3,000단어**까지 추출
- 추출 실패 시: OCR 폴백 → OCR도 실패 시 수동 입력으로 전환
- OpenAI 모델: `gpt-4o-mini` (비용 효율 + 충분한 분류 정확도)

#### 3.2.5 비용 추정

| 항목 | 값 |
|------|-----|
| 평균 입력 토큰 | ~2,000 tokens/문서 |
| 평균 출력 토큰 | ~200 tokens/문서 |
| gpt-4o-mini 비용 | ~$0.0005/문서 |
| 월 예상 (200건/월) | ~$0.10/월 |

---

## 4. 기술 설계

### 4.1 백엔드 변경사항

#### 4.1.1 새 서비스: `DocumentMetadataAnalyzer`

```java
@Service
public class DocumentMetadataAnalyzer {
    // 텍스트 추출 (첫 N페이지/N단어)
    MetadataExtractionResult extractAndAnalyze(MultipartFile file);
}
```

**위치**: `app-api/src/main/java/com/biorad/csrag/application/knowledge/`

#### 4.1.2 새 컨트롤러 엔드포인트

```java
// KnowledgeBaseController에 추가
@PostMapping("/documents/analyze-metadata")
public ResponseEntity<MetadataSuggestionResponse> analyzeMetadata(
    @RequestPart("file") MultipartFile file
);
```

#### 4.1.3 기존 업로드 API 유지

- `POST /api/v1/knowledge-base/documents` — 기존 API 변경 없음
- 프론트엔드에서 파일별로 순차 호출 (다중 파일 → 반복 호출)

### 4.2 프론트엔드 변경사항

#### 4.2.1 새 컴포넌트

```
src/components/knowledge-base/
├── FileDropZone.tsx          // 드래그&드롭 + 클릭 업로드 영역
├── FileQueue.tsx             // 업로드 큐 (파일 목록 + 진행률)
├── FileQueueItem.tsx         // 개별 파일 카드 (메타데이터 편집 폼 포함)
└── SmartUploadModal.tsx      // 통합 업로드 모달 (기존 모달 대체)
```

#### 4.2.2 새 API 클라이언트 함수

```typescript
// client.ts에 추가
export async function analyzeKbMetadata(file: File): Promise<MetadataSuggestion>;
```

#### 4.2.3 상태 관리 흐름

```
1. 파일 드롭/선택 → fileQueue[] 상태에 추가
2. 각 파일에 대해 analyzeKbMetadata() 비동기 호출
3. AI 응답 수신 → 해당 파일의 메타데이터 필드 자동 채움
4. 사용자 검토/수정
5. "전체 등록" 클릭 → uploadKbDocument() 순차 호출
6. 진행률 업데이트 → 완료/실패 표시
```

### 4.3 시퀀스 다이어그램

```
사용자         프론트엔드              백엔드 API            OpenAI
  │                │                      │                    │
  │── 파일 드롭 ──→│                      │                    │
  │                │── POST /analyze ─────→│                    │
  │                │   (파일 전송)          │── 텍스트 추출 ────→│
  │                │                      │                    │
  │                │                      │←── 추출 결과 ──────│
  │                │                      │── ChatCompletion ─→│
  │                │                      │                    │
  │                │                      │←── JSON 응답 ──────│
  │                │←── 메타데이터 제안 ───│                    │
  │                │                      │                    │
  │←─ 폼 자동 채움─│                      │                    │
  │                │                      │                    │
  │── 검토/수정 ──→│                      │                    │
  │── "등록" ─────→│                      │                    │
  │                │── POST /documents ───→│                    │
  │                │  (파일 + 메타데이터)   │                    │
  │                │←── 201 Created ──────│                    │
  │←─ 완료 표시 ──│                      │                    │
```

---

## 5. 스프린트 분해

### Sprint 10: 드래그&드롭 + 다중 파일 업로드 (프론트엔드 중심)

| Task | Story Points | 담당 |
|------|:---:|------|
| T10-1: `FileDropZone` 컴포넌트 개발 (드래그&드롭 + 클릭) | 3 | FE |
| T10-2: `FileQueue` / `FileQueueItem` 컴포넌트 개발 | 5 | FE |
| T10-3: `SmartUploadModal` 통합 (기존 모달 대체) | 3 | FE |
| T10-4: 다중 파일 순차 업로드 로직 + 프로그레스 바 | 3 | FE |
| T10-5: 파일 검증 (타입, 크기, 개수) + 에러 핸들링 | 2 | FE |
| T10-6: E2E 테스트 (드래그&드롭, 다중 업로드) | 2 | QA |
| **합계** | **18** | |

### Sprint 11: AI 메타데이터 자동 생성 (풀스택)

| Task | Story Points | 담당 |
|------|:---:|------|
| T11-1: `DocumentMetadataAnalyzer` 서비스 구현 | 5 | BE |
| T11-2: 텍스트 추출 유틸 (PDF 첫 N페이지, DOCX 첫 N단어) | 3 | BE |
| T11-3: OpenAI 프롬프트 설계 + 응답 파싱 | 3 | BE |
| T11-4: `POST /analyze-metadata` 엔드포인트 추가 | 2 | BE |
| T11-5: FE `analyzeKbMetadata()` 클라이언트 + UI 통합 | 3 | FE |
| T11-6: AI 추천 필드 UI (배지, 수정 가능 상태) | 2 | FE |
| T11-7: 에러 폴백 (분석 실패 → 수동 입력) | 1 | FE |
| T11-8: 통합 테스트 + E2E 테스트 | 3 | QA |
| **합계** | **22** | |

---

## 6. 비기능 요구사항

### 6.1 성능

| 지표 | 목표 |
|------|------|
| AI 메타데이터 분석 응답 시간 | < 10초/문서 |
| 파일 업로드 속도 (50MB) | < 30초 |
| 10건 일괄 업로드 총 소요시간 | < 3분 (AI 분석 포함) |

### 6.2 보안

- 업로드 파일은 서버 사이드에서 MIME 타입 재검증 (Content-Type 스푸핑 방지)
- 업로드 디렉토리는 웹 접근 불가 경로에 위치
- AI 분석용 텍스트는 메모리에서만 처리, 별도 저장하지 않음
- OpenAI API 호출 시 PII(개인식별정보) 필터링 고려

### 6.3 접근성

- 드래그&드롭 영역은 키보드로도 접근 가능 (Enter/Space로 파일 대화상자)
- 파일 큐 항목은 키보드 탐색 가능
- 스크린리더를 위한 ARIA 라벨 제공
- 업로드 진행 상황은 `aria-live="polite"`로 실시간 공지

---

## 7. 엣지 케이스 및 에러 처리

| 시나리오 | 처리 방안 |
|----------|-----------|
| 11개 이상 파일 드롭 | "최대 10개까지 업로드 가능합니다" 토스트, 초과분 무시 |
| 50MB 초과 파일 포함 | 해당 파일에 에러 표시, 나머지는 정상 큐잉 |
| 지원하지 않는 파일 형식 | 해당 파일에 에러 표시, 나머지는 정상 큐잉 |
| AI 분석 API 타임아웃 (>15초) | 타임아웃 후 수동 입력으로 전환, "AI 분석 시간 초과" 표시 |
| AI 분석 결과 confidence < 0.5 | "AI 추천 신뢰도가 낮습니다. 직접 확인해 주세요" 경고 표시 |
| 업로드 중 네트워크 끊김 | 실패 건 표시 + "재시도" 버튼 |
| 동일 파일명 중복 드롭 | "이미 추가된 파일입니다" 경고, 중복 추가 차단 |
| OpenAI API 키 미설정 | AI 분석 건너뛰기, 수동 입력 모드로 자동 전환 |
| 브라우저 드래그&드롭 미지원 | 파일 선택 버튼만 표시 (graceful degradation) |

---

## 8. 와이어프레임 (텍스트)

### 8.1 업로드 모달 - 초기 상태

```
┌─────────────────────────────────────────────────┐
│  문서 등록                                    [X] │
│                                                  │
│  ┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐  │
│  │                                            │  │
│  │        [  업로드 아이콘  ]                   │  │
│  │                                            │  │
│  │   파일을 이곳에 드래그하거나 클릭하세요        │  │
│  │   PDF, DOC, DOCX · 최대 50MB · 10개까지     │  │
│  │                                            │  │
│  └─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘  │
│                                                  │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 8.2 업로드 모달 - 파일 큐 + AI 분석 상태

```
┌─────────────────────────────────────────────────┐
│  문서 등록 (3건)                              [X] │
│                                                  │
│  ┌──────────────────────────────────────────┐    │
│  │ [PDF] CFX96_Manual.pdf        2.3MB [X]  │    │
│  │ [AI 분석 완료]  신뢰도: 87%               │    │
│  │                                          │    │
│  │ 제목:     [CFX96 Touch 사용자 매뉴얼  ] [AI] │  │
│  │ 카테고리: [매뉴얼 ▼                   ] [AI] │  │
│  │ 제품군:   [Real-Time PCR              ] [AI] │  │
│  │ 설명:     [CFX96 Touch 시스템의 설치...] [AI] │  │
│  │ 태그:     [CFX96, PCR, 설치, 프로토콜 ] [AI] │  │
│  └──────────────────────────────────────────┘    │
│                                                  │
│  ┌──────────────────────────────────────────┐    │
│  │ [DOC] Protocol_v2.docx        1.1MB [X]  │    │
│  │ [AI 분석 중...]  ████████░░ 80%           │    │
│  └──────────────────────────────────────────┘    │
│                                                  │
│  ┌──────────────────────────────────────────┐    │
│  │ [PDF] Spec_Sheet.pdf          0.5MB [X]  │    │
│  │ [대기 중]                                 │    │
│  └──────────────────────────────────────────┘    │
│                                                  │
│  + 파일 추가                                     │
│                                                  │
│  ──────────────────────────────────────────────  │
│                        [취소]  [3건 전체 등록]    │
└──────────────────────────────────────────────────┘
```

---

## 9. 성공 지표 (KPI)

| 지표 | 현재 | 목표 | 측정 방법 |
|------|------|------|-----------|
| 문서 등록 소요 시간 (건당) | ~60초 | **< 15초** | 프론트엔드 이벤트 로깅 |
| 메타데이터 입력 완성도 | ~65% | **> 90%** | 빈 필드 비율 모니터링 |
| 카테고리 정확도 | 수동 입력 | **> 85%** | 수정 비율 추적 |
| 10건 일괄 등록 소요 시간 | ~10분 | **< 3분** | 프론트엔드 이벤트 로깅 |
| 사용자 만족도 (SUS 점수) | 미측정 | **> 75점** | 분기별 설문조사 |

---

## 10. 리스크 및 완화 전략

| 리스크 | 영향 | 확률 | 완화 전략 |
|--------|------|------|-----------|
| OpenAI API 응답 지연/장애 | AI 분석 불가 | 중 | 수동 입력 폴백 + 타임아웃 처리 |
| AI 카테고리 분류 정확도 부족 | 메타데이터 품질 저하 | 중 | Few-shot 프롬프트 최적화, 피드백 루프 반영 |
| 대용량 파일 업로드 시 브라우저 메모리 | UX 저하 | 저 | 파일 스트리밍 업로드, 청크 전송 고려 |
| 비영어 문서 분석 정확도 | 한국어 문서 분류 오류 | 중 | 한국어 특화 프롬프트, 테스트 데이터 확보 |

---

## 11. 범위 제외 (Out of Scope)

- 문서 버전 관리 (동일 문서 재업로드 시 버전 추적)
- 폴더 단위 업로드
- 실시간 협업 편집
- AI 학습/파인튜닝 (기성 모델 프롬프팅만 사용)
- 파일 미리보기 (PDF 뷰어)
- 클립보드 붙여넣기 업로드

---

## 12. 의존성

| 의존 항목 | 상태 | 비고 |
|-----------|------|------|
| OpenAI API 키 설정 | 기존 환경변수 활용 | `OPENAI_API_KEY` |
| PDF 텍스트 추출 라이브러리 | 기존 `DocumentTextExtractor` 활용 | 페이지 제한 파라미터 추가 필요 |
| 기존 KB 업로드 API | 안정 | 변경 없이 재사용 |
| 기존 KB 업로드 모달 (FE) | **대체 대상** | `SmartUploadModal`로 교체 |

---

## 부록: 체크리스트

### Definition of Ready (DoR)
- [ ] 디자인 와이어프레임 리뷰 완료
- [ ] API 스펙 리뷰 완료
- [ ] 기술 의존성 확인 완료
- [ ] 테스트 데이터 (샘플 PDF/DOC) 준비

### Definition of Done (DoD)
- [ ] 모든 AC 통과
- [ ] 단위 테스트 커버리지 80% 이상
- [ ] E2E 테스트 통과
- [ ] 코드 리뷰 승인
- [ ] 접근성 검증 (키보드, 스크린리더)
- [ ] 성능 목표 달성 확인
- [ ] 한국어 UI 레이블 적용 완료
