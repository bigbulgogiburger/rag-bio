# PRD v3.1 — 답변 탭 UX 개선 및 보완 요청 실효성 확보

> **문서 버전:** 3.1
> **작성일:** 2026-02-21
> **작성자:** AI Agile Planning
> **상태:** Draft → 즉시 실행

---

## 0. 문서 목적

PRD v3 (Sprint 10)에서 보완 요청 기능, SelfReview 파이프라인을 구현했으나, 실 운영 피드백에서 **4가지 UX/기능 문제**가 도출되었다. 본 PRD는 이를 해결하기 위한 기능 요구사항과 실행 계획을 기술한다.

---

## 1. 현황 분석

### 1.1 문제 정의

| # | 문제 | 심각도 | 현재 상태 |
|---|------|--------|----------|
| P8 | **보완 요청과 워크플로우 액션 순서 역전** | Medium | 답변 초안 생성 후 "워크플로우 액션(검토/승인/발송)" → "보완 요청" 순서로 배치. 사용자 흐름상 **보완을 먼저 하고 → 만족하면 워크플로우를 진행**하는 것이 자연스러움 |
| P9 | **보완 요청 이력 미표시** | High | 보완 요청 시 어떤 추가 지시사항을 입력했는지 이력 탭에 표시되지 않음. CS 담당자가 과거 보완 요청 맥락을 추적할 수 없음 |
| P10 | **보완 요청이 실제 답변에 반영되지 않음** | Critical | `DefaultComposeStep.createRefinedDraft()`가 단순 텍스트 병합만 수행. LLM을 활용하지 않아 보완 지시사항이 답변 재작성에 전혀 반영되지 않음. 클라이언트: "보완을 요청했는데 적용이 안 되는 것 같다" |
| P11 | **이력 탭에 워크플로우 액션/보완 요청 부재** | High | 이력이 많은 경우 답변 탭에서는 최신 버전만 관리 가능. 이력 탭에서 과거 버전 선택 후 워크플로우 진행이나 보완 요청을 할 수 없음 |

### 1.2 근본 원인 분석

```
P8 → InquiryAnswerTab.tsx JSX 순서가 워크플로우(line 957) → 보완(line 1353).
     단순 DOM 순서 변경으로 해결 가능.

P9 → AnswerDraftResult에 additionalInstructions 필드가 있으나
     (백엔드 AnswerDraftResponse에도 포함),
     InquiryHistoryTab.tsx에서 해당 필드를 표시하지 않음.

P10 → DefaultComposeStep.createRefinedDraft()가 LLM 미호출.
     보완 지시사항을 "[보완 사항]" 마크다운 섹션으로 기존 답변에 붙이기만 함.
     실제 재작성이 이루어지지 않음.
     SelfReview 피드백 재작성도 동일한 한계.

P11 → InquiryHistoryTab.tsx가 읽기 전용 뷰.
     워크플로우 API(review/approve/send)와 보완 요청 API를 호출하는 UI 없음.
```

---

## 2. 목표 (Goals)

| 목표 | 측정 지표 | 목표값 |
|------|----------|--------|
| 보완 → 워크플로우 자연스러운 흐름 | 사용자 혼란 문의 | 0건 |
| 보완 요청이 실제 답변에 반영됨 | 보완 후 만족도 (수정 없이 승인) | 70% |
| 이력 탭에서 과거 버전 관리 가능 | 이력 탭 워크플로우 실행 비율 | 30% |

### 비목표 (Non-Goals)

- LLM 모델 변경
- 보완 요청 UI 디자인 전면 리뉴얼
- 이력 탭 무한 스크롤/가상화

---

## 3. 기능 요구사항

### 3.1 [P8] 보완 요청 → 워크플로우 액션 순서 변경

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| P8-1 | 답변 초안 카드 내 순서: 답변 본문 → **보완 요청** → **워크플로우 액션** | Must |

**변경 파일:** `InquiryAnswerTab.tsx` — JSX 블록 순서 변경

**변경 전:**
```
답변 본문 → Self-Review 결과 → 리뷰/승인 정보 → 워크플로우 액션 → 보완 요청
```

**변경 후:**
```
답변 본문 → Self-Review 결과 → 리뷰/승인 정보 → 보완 요청 → 워크플로우 액션
```

---

### 3.2 [P9] 보완 요청 이력 표시

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| P9-1 | 이력 탭 버전 상세에 "보완 요청 내용" 섹션 표시 | Must |
| P9-2 | additionalInstructions가 있는 버전은 "보완" 배지 표시 | Must |
| P9-3 | 이전 답변(previousAnswerId) 참조 링크 표시 | Should |

**변경 파일:** `InquiryHistoryTab.tsx`

**UX:**
```
v3 버전 상세
├── [보완] 배지 표시
├── 보완 요청 내용: "보관 절차의 구체적 방법을 추가해주세요"
├── 이전 버전: v2 (클릭 시 해당 버전으로 이동)
└── 답변 초안 본문 ...
```

---

### 3.3 [P10] 보완 요청 실효성 확보 (ComposeStep LLM 전환)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| P10-1 | createRefinedDraft()에서 LLM 호출로 보완 지시사항 반영한 답변 재작성 | Must |
| P10-2 | 기존 답변의 좋은 부분 유지 + 보완 지시사항만 반영 | Must |
| P10-3 | 톤/채널 설정이 보완 답변에도 적용 | Must |
| P10-4 | OPENAI_ENABLED=false(mock 모드)에서도 동작 (폴백 로직) | Must |
| P10-5 | SelfReview 피드백 재작성도 동일하게 LLM 기반으로 전환 | Should |

**변경 파일:**
- `DefaultComposeStep.java` — createRefinedDraft()를 LLM 기반으로 전환
- OpenAI 서비스 의존성 추가 (기존 프로젝트의 OpenAiService 활용)

**핵심 프롬프트 설계:**
```
System: 당신은 Bio-Rad 고객기술지원팀의 응답 작성 전문가입니다.
기존 답변을 기반으로 보완 지시사항을 반영하여 개선된 답변을 작성하세요.

규칙:
1. 기존 답변의 정확한 정보는 유지하세요
2. 보완 지시사항에서 요청한 내용만 추가/수정하세요
3. 인용(파일명.pdf, p.X-Y)은 그대로 유지하세요
4. {tone} 톤으로 작성하세요
5. 중복 서술을 피하세요

기존 답변:
{previousDraft}

보완 지시사항:
{additionalInstructions}

참고 근거:
{evidences}
```

**Mock 모드 폴백:** OPENAI_ENABLED=false일 때는 기존 텍스트 병합 방식 유지 (현재 로직)

---

### 3.4 [P11] 이력 탭 워크플로우 액션 + 보완 요청 추가

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| P11-1 | 이력 탭에서 선택된 버전에 대해 워크플로우 액션(검토/승인/발송) 가능 | Must |
| P11-2 | 이력 탭에서 선택된 버전에 대해 보완 요청 가능 | Must |
| P11-3 | 워크플로우 액션 후 이력 목록 자동 새로고침 | Must |
| P11-4 | SENT 상태 버전은 워크플로우/보완 비활성화 | Must |

**변경 파일:** `InquiryHistoryTab.tsx`

**UX:**
```
v3 버전 상세
├── 답변 초안 본문
├── 보완 요청 섹션 (답변 탭과 동일)
├── 워크플로우 액션 섹션 (답변 탭과 동일)
└── 참조 자료
```

---

## 4. 비기능 요구사항

| 항목 | 요구사항 |
|------|---------|
| 성능 | LLM 기반 보완 답변 생성 ≤ 30초 |
| 호환성 | Mock 모드(OPENAI_ENABLED=false)에서 기존 동작 유지 |
| 호환성 | 기존 API 하위 호환 |

---

## 5. 실행 계획

### 의존 관계

```
P8  (UI 순서 변경) ─────── 독립, 즉시 착수
P9  (보완 이력 표시) ────── 독립, 즉시 착수
P10 (ComposeStep LLM) ──── 독립, 즉시 착수
P11 (이력 탭 액션) ──────── P8, P9 완료 후 진행 (답변탭 패턴 확정 후 이력탭에 적용)
```

### 병렬 실행 구성

| 에이전트 | 태스크 | 예상 복잡도 |
|---------|--------|-----------|
| **frontend-dev** | P8 (순서 변경) + P9 (보완 이력) → P11 (이력 탭 액션) | Medium |
| **backend-dev** | P10 (ComposeStep LLM 전환) | High |
